---
name: code-review
description: コード/スクリプト変更のレビュー観点・手順・指摘方法を提供する。ユーザーがレビュー（PR/差分/リスク/回帰/テスト不足の洗い出し）を求める場合に使用する。
metadata:
  short-description: コードレビュー
---

# Code Review

## Overview

変更内容を精査し、バグ・回帰・セキュリティ・性能・可用性・保守性の観点で指摘と改善案を提示する。
レビューはリスクの早期発見を最優先とする。
レビュー結果は重大度順に、根拠と具体的な修正案を添えて簡潔に示す。

## 対象外

- 実装や修正を直接実行する依頼（レビューではなく実装スキルを優先）。
- ドキュメントの文面調整のみで、挙動リスク評価が不要な依頼。

## Workflow

### 1) 事前確認

- 対象範囲（PR・差分・特定ファイル）と期待する深さを確認する
- 目的・制約（互換性、性能目標、セキュリティ要件、運用ルール）を確認する
- レビュー範囲と除外範囲（自動生成コード、外部依存のベンダーコードなど）を確認する
- 不明点があれば質問してから進める

### 2) 変更内容の把握

- 変更理由と影響範囲を要約する（1〜2文）
- 既存挙動からの差分・副作用を意識して読む
- 読む範囲は「差分中心＋影響範囲の要所だけ確認」を基本とする
- 具体的には「呼び出し元・呼び出し先・入出力境界」を優先的に確認する
- 重大変更や事故対応など特別な場合のみ広範囲を読む

### 3) リスク評価（重点項目）

- 正しさ: 境界条件、例外処理、入力検証、並行性・再入性
- 回帰: 既存の契約（API・CLI・設定・データ形式）破壊の有無
- セキュリティ: 認可・検証・機密漏洩・コマンド注入など
- 性能・資源: ボトルネック、N+1、メモリ・入出力
- 運用: ログ、エラーメッセージ、監視しやすさ、デバッグ性
- テスト: 追加・更新・不足、再現手順の妥当性
- コーディング標準: 既存の規約・lint・formatterがあれば優先し、なければ coding-standards スキルの原則に照らして確認する

### 4) 指摘の整理

- 重大度順に列挙（重大・高・中・低）
- ファイルと行番号を明示
- 影響と理由を一文で述べ、具体的な修正案を添える
- 断定できない場合は前提や確認事項を明示する
- 断定度（確定/可能性）を示し、根拠の種類（コード、テスト、仕様）を添える

## レビュー・改善サイクル（必須）

- 生成・修正する内容（指摘、修正案、確認事項など）は、提示前にレビューする。
- レビュー結果を反映して改善し、これを3回繰り返す。
- 3回目の改善結果を最終案として採用し、ユーザーには最終案のみ提示する（途中案は原則提示しない）。
- 途中案や各ラウンドの内容は、ユーザーから明示的に要求された場合にのみ提示する。
- ユーザー指定や既存規約がある場合は、それらを優先して最終案に反映する。

## Output Guidelines

### 構成

- 冒頭に指摘数（重大・高・中・低）を1行で示す
- 最初に「指摘事項（重大度順）」を出す
- 指摘がない場合は「指摘なし」と明記し、残リスク・確認事項を短く添える
- 次に「質問・前提（不明点）」を出す
- 最後に「変更の要約」や「テスト・検証提案」を短く添える

### 書き方のポイント

- 断定できない場合は「〜の可能性」「〜なら問題」など条件付きで記述
- 代替案が複数ある場合は、選択理由を簡潔に添える
- 重大度はリスクの大きさで判断し、些細な指摘は最後にまとめる

## Test Review Checklist

- 変更に対応するテストが追加・更新されているか
- 既存テストの期待値が変更に合わせて更新されているか
- 失敗ケース・境界条件のテストがあるか
- 再現手順がある場合、手順と期待結果が妥当か
- テストが不足している場合、最小の追加案を提案する
- テストを実行できない場合は理由と代替検証案を示す

### 指摘テンプレ

以下の形式で簡潔に書く。

```txt
指摘:
理由・影響:
修正案:
根拠:
確度:
```

### 例文

良い指摘:

```txt
指摘: 入力のバリデーションが不足しており、空文字列でも処理が進んでしまいます。
理由・影響: 空文字列の場合に後続が想定外の状態になり、特定条件で例外が発生する可能性があります。
修正案: 早期リターンで空文字列を弾くか、呼び出し側で必須入力を保証してください。
```

悪い指摘:

```txt
指摘: ここは良くないです。
理由・影響: なんとなく不安です。
修正案: 直してください。
```

### 重大度の定義

- 補足: 影響範囲が限定的で回避策が容易な場合は、重大度を1段階下げて扱う
- 重大: データ損失、セキュリティ事故、サービス停止、不可逆な破壊、重大なコンプライアンス違反に直結
- 高: 本番影響が高い不具合、回帰が確定的、ユーザー体験を大きく損なう、容易に悪用されうる欠陥
- 中: 特定条件で不具合、劣化や非効率が顕著、将来的な保守性を大きく下げる設計
- 低: 可読性や一貫性の改善、軽微な最適化、リスクが限定的な改善提案

### 重大度の例

- 重大: 認可チェックが抜けており、他ユーザーのデータにアクセス可能
- 高: 既存APIの戻り値が互換性なく変更されている
- 中: ループ内で重い入出力が発生し、データ量によって遅延が顕著
- 低: 命名やフォーマットの不統一で読みづらい

## Coding Standards Review

- コーディング標準の確認が必要な場合、まずプロジェクト内の規約・設定（README・CONTRIBUTING・lint・formatter）を探す
- 複数ある場合は「公式ドキュメント > CONTRIBUTING > lint・formatter設定 > README」の順で優先する
- どれも見つからない場合は coding-standards スキルを読み、そこに書かれた原則をレビュー観点として適用する
- 指摘は「どの原則に抵触するか」「なぜリスク・保守性に影響するか」をセットで書く
