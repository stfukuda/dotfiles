---
name: coding-standards
description: コード/スクリプトの実装・修正・リファクタ時に適用する品質原則を提供する。ユーザーが実装や修正の品質基準・書き方の指針を求める場合に使用する（ドキュメント更新のみ、レビューのみは対象外）。
metadata:
  short-description: コーディング標準
---

# コーディング標準

## 概要

正確で保守しやすくレビュー可能な変更を実現するため、汎用的なコード品質の原則を適用する。
言語・フレームワーク・プロジェクトを問わず本ガイドラインを使用する。
コード・スクリプトの編集時に適用する（通常のドキュメント編集は対象外）。

## 適用対象

- コード/スクリプトの実装・修正・リファクタ。
- 挙動変更の有無に関わらず、保守性と可読性の確保が必要な変更。
- 設定変更を含む実装作業（ドキュメントのみの変更は除く）。

## 対象外

- ドキュメント更新のみの依頼。
- 変更を伴わないレビュー専用の依頼。

## 共通ルール

- 既存のREADME・CONTRIBUTING・lint設定・フォーマッタ設定があれば優先する。
- 既存の標準テスト・ビルド手順があれば実行し、できない場合は理由を報告する。
- トレードオフが必要なら、コードコメントで理由を最小限に記録する。

## 適用手順

### 1) 規約の収集

- 既存規約（README/CONTRIBUTING/lint/formatter）を確認する。
- 規約が複数ある場合は、より拘束力が高いもの（CIで検証される設定）を優先する。

### 2) 変更方針の明確化

- 変更の目的と非目的を整理する。
- 影響範囲（関数、モジュール、I/O境界）を明示する。
- 原則間のトレードオフが予想される箇所を事前に列挙する。

### 3) 実装中のチェック

- 原則に照らして実装し、逸脱がある場合は理由を残す。
- 境界（入力検証、エラーハンドリング、外部依存）で破綻しないか確認する。

### 4) 実装後の検証

- テスト/ビルド/lint/formatter を可能な範囲で実行する。
- 実行不可の場合は理由と代替確認を明示する。

## 原則（優先順）

番号が小さいほど優先する。
原則が衝突する場合は優先順位に従い、必要に応じて理由を記録する。

### 1. 可読性を最優先

- 読まれることを前提にする
- コメントに頼らず自己説明的なコードにする
- フォーマット・命名規則は一貫させる
- 1つの処理は短く区切り、追いやすくする

### 2. KISS (Keep It Simple Stupid)

- 動く範囲で最もシンプルな解決策を選択する
- 過度な設計や抽象化で複雑にしない
- 分岐・入れ子・例外パスを増やし過ぎない
- 最適化は必要が見えてから実施する
- 「賢い」より「理解しやすい」を優先する

### 3. YAGNI (You Aren't Gonna Need It)

- 今の要件にない機能は実装しない
- 先読みの汎用化や拡張ポイントを作り過ぎない
- 複雑さは必要になったタイミングで追加する
- まず最小構成で作り、必要に応じて改善する
- 予測より実測（要件・利用）を根拠にする

### 4. DRY (Don't Repeat Yourself)

- 同じ意図の処理・ルールは1か所に集約する
- 共通処理は関数化・モジュール化する
- 定数・設定値・変換規則は集中管理する
- コピペで似た実装を増やさない
- 「似ているだけ」は無理に共通化しない

### 5. SRP (Single Responsibility Principle)

- 関数・クラスは「1つの目的」に絞る
- 1つの関数で検証・計算・入出力を混ぜない
- 変更理由が複数ある構造にしない
- 大きくなったら責務で分割して整理する
- 入口（入力）と出口（出力）を明確にする

### 6. PoLA (Principle of Least Astonishment)

- 名前から想像できる挙動に統一する
- 副作用がある処理は名前や構造で明示する
- 暗黙の前提（例: グローバル依存）を増やさない
- 例外的な挙動は局所化し、理由を記録する
- 呼び出し側が迷うAPI設計にしない

## エラーハンドリング

**原則として**エラーを適切に処理する:

```text
try:
  result = risky_operation()
  return result
catch error:
  log_error("Operation failed", error)
  raise user_friendly_error("Detailed user-friendly message")
```

- 失敗の文脈（入力・状態）を残し、原因追跡をしやすくする
- 回復可能かどうかを区別し、適切に伝播・回復する
- 例外を握りつぶさない

## 入力バリデーション

**外部入力や境界では必須**とする:

```text
schema = {
  email: string AND valid_email,
  age: integer AND 0 <= age <= 150
}

validated = validate(schema, input)
```

- 形式・範囲・必須・関係の制約を明示する
- 必要に応じて正規化（トリム・大小変換など）する
- 失敗時の扱い（エラー型・メッセージ）を定義する

## ファイル構成

**小さなファイルを多数にする方が望ましい**（目安・状況に応じて調整）:
ファイル構成はディレクトリ・ファイル単位の設計に関する指針であり、コード構造は関数/モジュール内の構造に関する指針である。

- 高凝集・低結合を維持する
- 目安: 200〜400行、上限: 800行
- 大きなコンポーネントはユーティリティを抽出する
- 種別ではなく機能・ドメインで整理する
- 分割し過ぎて追いにくい場合は統合を検討する
- 設定の集約は例外とする。整合性・変更管理を一元化するためである。

## コード構造

コード構造はファイル内の構造に関する指針である。

| パターン                    | 指針                                               |
| :-------------------------- | :------------------------------------------------- |
| **ガード節**                | エッジケースは早期リターンする                     |
| **フラットに保つ**          | 深いネストは避ける（目安: 2段以内、上限: 4段以内） |
| **合成（Composition）**     | 小さな関数を組み合わせる                           |
| **近接配置（Co-location）** | 関連するコードは近くに置く                         |

## 関数のルール

数値は目安・上限の指標。言語や文脈に応じて調整する。

| ルール             | 目安・意図                       |
| :----------------- | :------------------------------- |
| **短く保つ**       | 目安: 20〜30行、上限: 40行       |
| **責務を絞る**     | 1つの目的だけを扱う              |
| **抽象度を揃える** | 1つの関数で扱う抽象度は1段にする |
| **引数を絞る**     | 目安: 3つ以内（できれば0〜2）    |
| **副作用を抑える** | 入出力を予期せず書き換えない     |

## アンチパターン

| アンチパターン             | 改善                           |
| :------------------------- | :----------------------------- |
| 全行コメント               | 自明コメントは削除する         |
| 1行ヘルパー                | 意図が薄いならインライン化する |
| 単純生成ファクトリ         | 直接生成する                   |
| 単機能ユーティリティの集約 | 使う場所に置く（局所化する）   |
| 手順説明だけ               | 目的と実装を書く               |
| 深いネスト                 | 早期リターンする               |
| マジックナンバー           | 名前付き定数にする             |
| 神関数（巨大関数）         | 責務で分割する                 |

## コード品質チェックリスト

作業完了前に確認する:

- [ ] 可読性が確保され、命名が適切である
- [ ] ファイル構成が指針に沿っている（凝集・分割・配置）
- [ ] コード構造が指針に沿っている（ガード節・浅いネスト・合成・近接配置）
- [ ] 関数・ファイル・ネストの数値指標に沿っている
- [ ] エラーハンドリングが適切に実施されている
- [ ] 失敗時の挙動（伝播・回復）が明確である
- [ ] 入力バリデーションが境界で実施されている
- [ ] 変更に応じてテスト・検証が更新されている
- [ ] 例外がある場合は理由が説明されている

## 出力フォーマット

```markdown
# コーディング標準適用結果: [変更名]

## 適用した規約

- 参照規約:
- 優先順位:

## 適用した原則

- [原則名]: [適用内容]

## 例外と理由

- [原則名]: [例外理由]

## 検証

- 実行した確認:
- 未実行項目:
- 代替確認:
```

## 確認が必要なとき

- 要件が曖昧または既存挙動と衝突する場合は確認する。
- 変更が外部API・データ形式・マイグレーションに影響しうる場合は確認する。
- セキュリティ・プライバシー・コンプライアンスへの影響が不明な場合は確認する。
