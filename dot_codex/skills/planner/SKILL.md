---
name: planner
description: 実装や設計変更の実行計画（要件整理、影響範囲、実装順序、検証手順）を作る。曖昧な相談や指示（「〜したい」「〜できないか」など）を具体的な要件に落とし込み、段階的な計画にしたい場合に使用する（既存挙動維持を主目的としたリファクタ計画は refactor-safely）。
metadata:
  short-description: プランニング
---

# Planner

規模に関わらず変更に対して、実行可能で段階的な実装計画を作成する。

## 目的

- 要件を明確化し、成功基準までの道筋を示す。
- 依存関係と影響範囲を特定し、リスクを減らす。
- 実装順序と検証手順を整理し、実行しやすい計画にする。

## 対象外

- ユーザーが計画作成を不要と明示した場合。

## レビュー・改善サイクル（必須）

- 生成・修正する内容（計画、手順、文面、設定、変更案など）は、提示または適用前にレビューする。
- レビュー結果を反映して改善し、これを3回繰り返す。
- 3回目の改善結果を最終案として採用し、ユーザーには最終案のみ提示する（途中案は原則提示しない）。
- 途中案や各ラウンドの内容は、ユーザーから明示的に要求された場合にのみ提示する。
- ユーザー指定や既存規約がある場合は、それらを優先して最終案に反映する。

## 役割

- 要件分析と前提整理
- 既存構造の把握と影響範囲の特定
- 実装ステップの分解と順序化
- テスト戦略の提示
- リスクと対策の整理

## プロセス

### 1) 要件分析

- 依頼内容を完全に理解する。
- 「〜したい」「〜できないか」などの曖昧表現を検知したら、要件化のステップを先に行う。
- 不明点があれば質問する。
- 成功基準を明確にする。
- 前提・制約を列挙する。
- 情報不足の場合は、最小限の追加質問で補う。

#### 曖昧依頼の要件化ステップ

- 依頼の背景と目的（なぜ必要か）を確認する。
- 現状の課題と期待結果（どうなれば成功か）を確認する。
- 非目的（今回はやらないこと）を明確にする。
- 制約（期限、互換性、運用、工数、利用可能な技術）を列挙する。
- 優先順位（必須/任意）を整理する。
- 受け入れ条件を「検証可能な条件」で定義する。
- 未確定事項が残る場合は、仮定を明示して確認が取れるまで計画を確定しない。

### 2) 構造確認

- 既存コード構造を把握する。
- 影響を受けるコンポーネントを特定する。
- 類似実装や再利用可能パターンを確認する。

### 3) 手順分解

- 具体的な行動に分解する。
- 変更箇所（ファイルパス）を明示する。
- 依存関係を示す。
- リスクを明記する。

### 4) 実装順序

- 依存関係を優先して並べる。
- 関連変更をまとめて文脈切替を減らす。
- 各ステップが検証可能になるようにする。

## 出力フォーマット

```markdown
# 実装計画: [機能名]

## 概要

[2〜3文で要約]

## 要件

- [要件1]
- [要件2]

## 要件化サマリ（曖昧依頼の場合）

- 目的:
- 背景/課題:
- 期待結果:
- 非目的:
- 制約:
- 優先順位:
- 受け入れ条件:
- 未確定事項:

## 影響範囲・変更点

- [変更点1: ファイルパスと説明]
- [変更点2: ファイルパスと説明]
- 依存関係:
- 既存挙動:

## 実装ステップ

### フェーズ 1: [名称]

1. **[ステップ名]** (File: path/to/file)
   - Action: 具体的な作業内容
   - Why: この順序にする理由
   - Dependencies: なし / ステップXが必要
   - Risk: Low/Medium/High

### フェーズ 2: [名称]

...

## テスト戦略

- 単体テスト: [対象ファイル]
- 結合テスト: [対象フロー]
- E2Eテスト: [対象シナリオ]

## リスクと対応

- **リスク**: [内容]
  - 対応: [対策]

## 成功基準

- [ ] 基準1
- [ ] 基準2
```

## ベストプラクティス

- 具体的に書く（ファイルパス、関数名、設定名）。
- エッジケースや失敗経路を含める。
- 既存のパターンや規約に合わせる。
- 変更を最小限にし、段階的に進める。
- 各ステップが検証可能になるようにする。
- 何をするかだけでなく、なぜそうするかを書く。
- 曖昧な依頼は、要件化サマリを先に合意してから実装計画へ進む。

## リファクタ計画の指針

- 既存機能を維持する。
- 具体的な改善点を列挙する。
- 可能なら後方互換を保つ。
- 段階的な移行が必要なら移行手順を含める。

## 注意すべき兆候

- 大きな関数（50行超）
- 深いネスト（4階層超）
- 重複コード
- エラーハンドリング不足
- ハードコード値
- テスト不足
- 性能ボトルネック
